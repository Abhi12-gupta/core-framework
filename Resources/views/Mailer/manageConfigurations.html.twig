{% extends "@UVDeskCoreFramework//Templates//layout.html.twig" %}

{% block title %} 
	{{ 'Mailer Settings'|trans }}
{% endblock %}

{% block pageContent %}
	<div class="uv-inner-section">
		{# Append Panel Aside #}
		{% set asideTemplate = 'Webkul\\UVDesk\\CoreFrameworkBundle\\Dashboard\\AsideTemplate' %}
		{% set asideSidebarReference = 'Webkul\\UVDesk\\CoreFrameworkBundle\\UIComponents\\Dashboard\\Panel\\Sidebars\\Settings' %}

		{{ uvdesk_extensibles.getRegisteredComponent(asideTemplate).renderSidebar(asideSidebarReference) | raw }}

		<div class="uv-view {% if app.request.cookies and app.request.cookies.get('uv-asideView') %}uv-aside-view{% endif %}">
			{% if configuration is defined and configuration.id is not empty %}
                <h1>{{ 'Update configuration'|trans }}</h1>
            {% else %}
                <h1>{{ 'Add configuration'|trans }}</h1>
            {% endif %}

            <div class="uv-hr"></div>
			
			<form method="post" action="" id="mailer-settings-view">
                <div class="mailer-setting-type">
                    {# Mailer Id #}
                    <div class="uv-element-block">
                        <label class="uv-field-label">{{ 'Mailer ID'|trans }}</label>

                        <div class="uv-field-block">
                            {% if configuration is defined and configuration.id is not empty %}
                                <input type="text" name="id" class="uv-field" value="{{ configuration.id }}" placeholder="{{ 'Mailer ID - Leave blank to automatically create id'|trans }}" />
                            {% else %}
                                <input type="text" name="id" class="uv-field" value="" placeholder="{{ 'Mailer ID - Leave blank to automatically create id'|trans }}" />
                            {% endif %}
                        </div>
                    </div>

                    {# Transport Type #}
                    <div class="uv-element-block">
                        <label class="uv-field-label">{{ 'Transport Type'|trans }}</label>

                        {% if configuration is defined and configuration is not empty %}
                            <select name="transport" id="cta-mailer-transport" class="uv-select">
                                <option value="smtp" {% if configuration.transport == 'smtp' %}selected{% endif %}>{{ 'SMTP'|trans }}</option>
                                <option value="gmail" {% if configuration.transport == 'gmail' %}selected{% endif %}>{{ 'Gmail'|trans }}</option>
                                <option value="yahoo" {% if configuration.transport == 'yahoo' %}selected{% endif %}>{{ 'Yahoo'|trans }} </option>
                                <option value="outlook" {% if configuration.transport == 'outlook' %}selected{% endif %}>{{ 'Outlook'|trans }} </option>
                                <option value="outlook_oauth" {% if configuration.transport == 'outlook_oauth' %}selected{% endif %}>{{ 'Outlook Modern Auth'|trans }} </option>
                            </select>
                        {% else %}
                            <select name="transport" id="cta-mailer-transport" class="uv-select">
                                <option value="smtp" selected>{{ 'SMTP'|trans }}</option>
                                <option value="gmail">{{ 'Gmail'|trans }}</option>
                                <option value="yahoo">{{ 'Yahoo'|trans }}</option>
                                <option value="outlook">{{ 'Outlook'|trans }} </option>
                                <option value="outlook_oauth">{{ 'Outlook Modern Auth'|trans }} </option>
                            </select>
                        {% endif %}
                    </div>

                    {# Delivery Status #}
                    <div class="uv-element-block">
                        <label>
                            <div class="uv-checkbox">
                                {% if configuration.disableEmailDelivery is defined and configuration.disableEmailDelivery == true %}
                                    <input name="disableEmailDelivery" type="checkbox" checked="">
                                {% else %}
                                    <input name="disableEmailDelivery" type="checkbox">
                                {% endif %}

                                <span class="uv-checkbox-view"></span>
                            </div>

                            <span class="uv-checkbox-label">{{ 'Disable Delivery'|trans }}</span>
                        </label>
                    </div>

                    {# Security Check #}
                    <div class="uv-element-block">
                        <label>
                            <div class="uv-checkbox">
                                {% if configuration.useStrictMode is defined and configuration.useStrictMode == true %}
                                    <input name="useStrictMode" type="checkbox" checked="">
                                {% else %}
                                    <input name="useStrictMode" type="checkbox">
                                {% endif %}

                                <span class="uv-checkbox-view"></span>
                            </div>

                            <span class="uv-checkbox-label">{{ 'Use Strict Security Mode'|trans }}</span>
                        </label>
                    </div>
                </div>

                <div class="uv-hr"></div>

                <div class="mailer-transport-setting-references">

                </div>

				<input id="submitMailerConfigurations" class="uv-btn" href="#" value="{{ 'Save Changes'|trans }}" type="submit">
			</form>
		</div>
	</div>
{% endblock %}

{% block footer %}
	{{ parent() }}

    <script id="default_mailer_configuration_template" type="text/template">
        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Server'|trans }}</label>

            <div class="uv-field-block">
                <% if (typeof(host) != 'undefined' && host != '') { %>
                    <input type="text" name="host" class="uv-field" value="<%- host %>" />
                <% } else { %>
                    <input type="text" name="host" class="uv-field" value="" />
                <% } %>
            </div>
        </div>

        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Email'|trans }}</label>
            
            <div class="uv-field-block">
                <% if (typeof(user) != 'undefined' && user != '') { %>
                    <input type="text" name="user" class="uv-field" value="<%- user %>" />
                <% } else { %>
                    <input type="text" name="user" class="uv-field" value="" />
                <% } %>
            </div>
        </div>

        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Password'|trans }}</label>
            
            <div class="uv-field-block">
                <input type="password" name="pass" class="uv-field" value="" />
            </div>
        </div>

        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Port'|trans }}</label>
            
            <div class="uv-field-block">
                <% if (typeof(port) != 'undefined' && port != '') { %>
                    <input type="text" name="port" class="uv-field" value="<%- port %>" />
                <% } else { %>
                    <input type="text" name="port" class="uv-field" value="465" />
                <% } %>
            </div>
        </div>
	</script>

    <script id="gmail_mailer_configuration_template" type="text/template">
        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Email'|trans }}</label>

            <div class="uv-field-block">
                <% if (typeof(user) != 'undefined' && user != '') { %>
                    <input type="text" name="user" class="uv-field" value="<%- user %>" />
                <% } else { %>
                    <input type="text" name="user" class="uv-field" value="" />
                <% } %>
            </div>
        </div>

        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Password'|trans }}</label>

            <div class="uv-field-block">
                <input type="password" name="pass" class="uv-field" value="" />
            </div>
        </div>
	</script>

    <script id="yahoo_mailer_configuration_template" type="text/template">
        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Email'|trans }}</label>

            <div class="uv-field-block">
                <% if (typeof(user) != 'undefined' && user != '') { %>
                    <input type="text" name="user" class="uv-field" value="<%- user %>" />
                <% } else { %>
                    <input type="text" name="user" class="uv-field" value="" />
                <% } %>
            </div>
        </div>

        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Password'|trans }}</label>

            <div class="uv-field-block">
                <input type="password" name="pass" class="uv-field" value="" />
            </div>
        </div>
	</script>

    <script id="outlook_mailer_configuration_template" type="text/template">
        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Email'|trans }}</label>

            <div class="uv-field-block">
                <% if (typeof(user) != 'undefined' && user != '') { %>
                    <input type="text" name="user" class="uv-field" value="<%- user %>" />
                <% } else { %>
                    <input type="text" name="user" class="uv-field" value="" />
                <% } %>
            </div>
        </div>

        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Password'|trans }}</label>

            <div class="uv-field-block">
                <input type="password" name="pass" class="uv-field" value="" />
            </div>
        </div>
	</script>

    <script id="outlook_oauth_mailer_configuration_template" type="text/template">
        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Microsoft App'|trans }}</label>

            {% if microsoftAppCollection is defined and microsoftAppCollection is not empty %}
                <select name="app" class="uv-select">
                    {% for microsoftApp in microsoftAppCollection %}
                        <option value="{{ microsoftApp.id }}" selected>{{ microsoftApp.name }}</option>
                    {% endfor %}
                </select>
            {% else %}
                <select name="app" class="uv-select" disabled>
                    <option selected>{{ 'No configured microsoft app currently available'|trans }}</option>
                </select>
            {% endif %}
        </div>

        <p class="uv-field-info">Continue by signing in through microsoft to add a new account.</p>

        <a href="{{ path('uvdesk_member_core_framework_integrations_microsoft_apps_add_account', { appId: '1', origin: 'helpdesk_member_mailer_create_mailer_configuration' }) }}" class="uv-btn" style="background-color: #00a1f1;">Continue with Microsoft</a>

        <div class="uv-hr"></div>

        <p class="uv-field-info">Or select from one of the previously configured microsoft accounts.</p>

        <div class="uv-element-block">
            <label class="uv-field-label">{{ 'Email'|trans }}</label>

            {% if microsoftAccountCollection is defined and microsoftAccountCollection is not empty %}
                <select name="user" class="uv-select">
                    {% for microsoftAccount in microsoftAccountCollection %}
                        <option value="{{ microsoftAccount.id }}" selected>{{ microsoftAccount.email }}</option>
                    {% endfor %}
                </select>
            {% else %}
                <select name="user" class="uv-select" disabled>
                    <option selected>{{ 'No microsoft account currently available'|trans }}</option>
                </select>
            {% endif %}
        </div>
	</script>

	<script type="text/javascript">
		$(function () {
			var MailerSettingsModel = Backbone.Model.extend({
                idAttribute: "id",
                validation: {
                    user: function(value) {
                        if ('outlook_oauth' != this.get('transport')) {
                            if (value == undefined || value == '') {
                                return "Please enter a valid email address";
                            } else if (/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(value) == false) {
                                return "Please specify a valid email address";
                            }
                        }
                    },
                    pass: function(value) {
                        if ('outlook_oauth' != this.get('transport')) {
                            if (value == undefined || value == '') {
                                return "Please enter the password associated with your email address";
                            }
                        }
                    },
                    host: function(value) {
                        if ('smtp' == this.get('transport')) {
                            if (value == undefined || value == '') {
                                return "Please enter your server host address";
                            }
                        }
                    },
                    port: function(value) {
                        if ('smtp' == this.get('transport')) {
                            if (value == undefined || value == '') {
                                return "Please specify a port number to connect with your mail server";
                            }
                        }
                    }
				}
			});

			var MailerSettingsView = Backbone.View.extend({
                default_mailer_configuration_template: _.template($("#default_mailer_configuration_template").html()),
                gmail_mailer_configuration_template: _.template($("#gmail_mailer_configuration_template").html()),
                yahoo_mailer_configuration_template: _.template($("#yahoo_mailer_configuration_template").html()),
                outlook_mailer_configuration_template: _.template($("#outlook_mailer_configuration_template").html()),
                outlook_oauth_mailer_configuration_template: _.template($("#outlook_oauth_mailer_configuration_template").html()),
				events: {
                    'change #cta-mailer-transport': 'changeTransportType',
					'click #submitMailerConfigurations' : "submitMailerConfigurations",
				},
				initialize: function() {
                    Backbone.Validation.bind(this);
                    this.renderTransportConfigurations();
				},
                changeTransportType: function(e) {
                    if (true) {
                        this.model.set('transport', $(e.target).val());
                    }

                    this.renderTransportConfigurations();
                },
                renderTransportConfigurations: function() {
                    switch (this.model.get('transport')) {
                        case 'smtp':
                            $('.mailer-transport-setting-references').html(this.default_mailer_configuration_template(this.model.attributes));
                            break;
                        case 'gmail':
                            $('.mailer-transport-setting-references').html(this.gmail_mailer_configuration_template(this.model.attributes));
                            break;
                        case 'yahoo':
                            $('.mailer-transport-setting-references').html(this.yahoo_mailer_configuration_template(this.model.attributes));
                            break;
                        case 'outlook':
                            $('.mailer-transport-setting-references').html(this.outlook_mailer_configuration_template(this.model.attributes));
                            break;
                        case 'outlook_oauth':
                            $('.mailer-transport-setting-references').html(this.outlook_oauth_mailer_configuration_template(this.model.attributes));
                            break;
                        default:
                            break;
                    }
                },
                submitMailerConfigurations: function(e) {
                    e.preventDefault();
                    this.model.set(this.$el.serializeObject());

			        if (this.model.isValid(true)) {
			            this.$el.submit();
			        }
                }
			});

            {% if configuration is defined and configuration is not empty %}
                new MailerSettingsView({
                    el: $("#mailer-settings-view"),
                    model: new MailerSettingsModel($.parseJSON('{{ configuration|json_encode|raw }}'))
                });	
            {% else %}
                new MailerSettingsView({
                    el: $("#mailer-settings-view"),
                    model: new MailerSettingsModel({ transport: 'smtp' })
                });	
            {% endif %}
		});
	</script>
{% endblock %}